<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Export Vis</title>
<script language="javascript" type="text/javascript" src="js/jquery-1.5.2.js"></script>
<script language="javascript" type="text/javascript" src="js/exports.js"></script>
<script language="javascript" type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
</head>
<body>
<p>Right click to set pivot point. Then click on a path.</p>
<script type="text/javascript">

$(document).ready(function() {
    var geocoder = new google.maps.Geocoder(),
        source = "New Zealand",
        data = {},
        locations,
        pivotPoint = null;

    $exports.buildJSON(source, function(d) {
        data = d;
        build_geo_table(data);

        $.getJSON('public/nodesfile',function(loaded){
            data.nodes = loaded;

            var geocoder = new google.maps.Geocoder();
            
            geocoder.geocode({ address: source }, function(geo) {
                var opts = {
                  zoom: 8,
                  center: geo[0].geometry.location,
                  mapTypeId: google.maps.MapTypeId.ROADMAP
                }

                var map = new google.maps.Map(document.getElementById("map_canvas"), opts);
                var exports = data.exports.years['2010'];
                var totalExports = exports['(Total)'].exports;
                google.maps.event.addListener(map, 'rightclick', function(event){
                    // drop marker
                    pivotPoint = addMarker(map, event.latLng); 
                    
                });

                //from source node.
                var sourceNode = nodeOf(geo[0].geometry.location);
                var topQueue = data.nodes[sourceNode];
                $.each(topQueue, function(index, value){
                    drawFromNode(value, sourceNode);
                });

                function drawFromNode(node,parent){
                    //returns the weight of what its done.
                    var queue = data.nodes[node];
                    var pathExports =0; //sum of value for weight.
                    if (node in locations) {
                        //draw
                        var name = locations[node];
                        pathExports = new Number(exports[name].exports);
                    } else {
                        $.each(queue, function(key,value){
                            if (value != parent){
                                console.log(key + " "+value);
                                pathExports += drawFromNode(value, node);
                            }
                        });
                    }

                    console.log('drawing '+parent+'=>'+node+"\t\t"+pathExports);

                    var exportPath = new google.maps.Polyline({
                        path: [geoOfNode(parent), geoOfNode(node)],
                        strokeColor: "#FF0000",
                        strokeOpacity: 1,
                        strokeWeight: 0.1 + (pathExports / totalExports) * 10,
                        map: map
                    });

                    // drop markers again
                    if (!locations[geoOfNode(node)]) {
                        addMarker(map, geoOfNode(node));
                    }

                     google.maps.event.addListener(exportPath, 'click', function(event){
                          if (pivotPoint!=null){
                              var path = exportPath.getPath();
                              var n1 = nodeOf(path.getArray()[0]);
                              var n2 = nodeOf(path.getArray()[1]);
                              //todo update node structure.
                              //todo handle merges.
                              
                              var pn = nodeOf(pivotPoint.getPosition());

                              var node2 = data.nodes[n2];
                              var node1 = data.nodes[n1];

                              var idx = node1.indexOf(n2);
                              node1.splice(idx,1);
                              node1.push(pn);

                              idx = node2.indexOf(n1);
                              node2.splice(idx,1);
                              node2.push(pn);

                              data.nodes[pn] = [n1,n2];
                          }
                     });
                    return pathExports;
                  }
            });
        });
        
    });

    function addMarker(map, latlng) {
        var m = new google.maps.Marker({
            position: latlng, 
            map: map,
            animation: google.maps.Animation.DROP,
            title: 'pivot'
        });

        google.maps.event.addListener(m, 'click', function(){
            if (m.getAnimation() != null) {
                m.setAnimation(null);
            } else {
                m.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(function() {
                    m.setAnimation(null);
                }, 1000);
            }
        });

        return m;
    }

    function nodeOf(object){
        //this accuracy might be bad.

        if (typeof(object.lat) != "function" & typeof(object.lng) != "function"){
            return object.lat+"|"+object.lng;
        }
        return ""+object.lat()+"|"+object.lng();
    }

    function geoOfNode(node){
        var latLng = node.split("|");
        return new google.maps.LatLng(parseFloat(latLng[0]), parseFloat(latLng[1]));
    }

    function build_geo_table(data){
        locations = {};
        for (g in data.geo){
            locations[nodeOf(data.geo[g])] = g;
        }
    }

    function save(){
        var s_save = data.nodes;
        $.post('php/save.php?filename=nodesfile', {nodes: data.nodes });
        alert('save');
    }

    // add handler to debug button
    $('#btnDebug').click(function() {
        var pn = "-40.658953578756076|174.1867184029761"
        var au_off_nz = false;
        if ('-25.274398|133.77513599999997' in data.nodes['-40.900557|174.88597100000004']) au_off_nz =true;
        console.log(au_off_nz); // should be false.
        var piv_off_nz = false;
        if (pn in data.nodes['-40.900557|174.88597100000004']) piv_off_nz = true;
        console.log(piv_off_nz); // should be true

        console.log(data.nodes[pn]); // should have au & nz
        console.log(data.nodes['-25.274398|133.77513599999997']); // should have pivot node.
    });

    // add handler to save button
    $('#btnSave').click(function() {
        save();
    });
});

</script>
<div id="map_canvas" style="height:600px;width:1000px"></div> 
<input id="btnSave" type="button" value="save" />
<input id="btnDebug" type="button" value="debug" />
</body>
</html>
