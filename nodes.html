<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Export Vis</title>
<script language="javascript" type="text/javascript" src="js/jquery-1.5.2.js"></script>
<script language="javascript" type="text/javascript" src="js/exports.js"></script>
<script language="javascript" type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
</head>
<body>
<p>Right click to set pivot point. Then click on a path.</p>
<script type="text/javascript">

$(document).ready(function() {
    var geocoder = new google.maps.Geocoder(),
        data = {},
        source = "New Zealand";

    $exports.buildJSON(source, function(d) {
        data = d;
        
        var geocoder = new google.maps.Geocoder();
        
        geocoder.geocode({ address: source }, function(geo) {
            var opts = {
              zoom: 8,
              center: geo[0].geometry.location,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            }

            var map = new google.maps.Map(document.getElementById("map_canvas"), opts);
            var exports = data.exports.years['2010'];
            var totalExports = exports['(Total)'].exports;
            google.maps.event.addListener(map, 'rightclick', function(event){
                pivotPoint=event.latLng;
                alert('pivot');
                //todo drop marker
            });

            //from source node.
            var sourceNode = nodeOf(geo[0].geometry.location);
            var topQueue = data.nodes[sourceNode];
            while (topQueue.length != 0){
                drawFromNode(topQueue.pop(), sourceNode);
            }

            function drawFromNode(node,parent){
                //returns the weight of what its done.
               var queue = data.nodes[node];
               var pathExports =0;
               if (queue.indexOf(parent)!=-1){
                  //draw
                    var name = nameOfNode(node,data.geo);
                     pathExports = new Number(exports[name].exports);
               } else {
                   while(queue.length != 0){
                        pathExports += drawFromNode(queue.pop(), node);
                   }
               }

              var exportPath = new google.maps.Polyline({
                    path: [geoOfNode(parent), geoOfNode(node)],
                    strokeColor: "#FF0000",
                    strokeOpacity: 1,
                    strokeWeight: 0.1 + (pathExports / totalExports) * 10,
                    map: map
                  });

                google.maps.event.addListener(exportPath, 'click', function(event){
                    if (pivotPoint!=null){
                        var path = exportPath.getPath();
                        var l = path.pop();
                        path.push(pivotPoint);
                        path.push(l);
                        //todo update node structure.
                        //todo handle merges.
                    }
                  });
               return pathExports;
              }
        });
    });
});

function nodeOf(object){
    //this accuracy might be bad.
    return ""+object.lat()+"|"+object.lng();
}
function geoOfNode(node){
    var latLng = node.split("|");
    return new google.maps.LatLng(parseFloat(latLng[0]), parseFloat(latLng[1]));
}
function nameOfNode(node,contries){
    var g = geoOfNode(node);
    for ( c in contries){
        if (contries[c].lat==g.lat()){
            if (contries[c].lng == g.lng()) return c
        }
    }
    return "Your on a boat Nigger!"
}

</script>
<div id="map_canvas" style="height:600px;width:1000px"></div> 
</body>
</html>
